#!/usr/bin/env python3
#
#
# Copyright (c) 2018, Hiroyuki Ohsaki.
# All rights reserved.
#
# $Id: object.py,v 1.5 2018/05/25 07:44:02 ohsaki Exp ohsaki $
#

import math

import cell

max_id = 0

def generate_name(type, id):
    return '_{}{}'.format(type, id)

class Object:
    def __init__(
            self,
            type=None,
            name=None,
            x=None,
            y=None,
            width=None,
            height=None,
            color='white',
            alpha=1,
            priority=0,
            fixed=None,
            visible=True,
            fade_out=False,
            n=None,
            rotation=None,
            text=None,
            size=None,
            align=None,
            file=None,
            x2=None,
            y2=None,
            x3=None,
            y3=None,
            parent=None,
            src=None,
            dst=None,
            frame_color=None,
    ):
        global max_id
        max_id += 1
        if name is None:
            name = generate_name(type, max_id)
        self.id = max_id
        self.type = type
        self.name = name
        self.x = x
        self.y = y
        self.width = width
        self.height = height
        self.color = color
        self.frame_color = frame_color
        self.alpha = alpha
        self.priority = priority

        self.fixed = fixed
        self.visible = visible
        self.fade_out = fade_out

        self.n = n
        self.rotation = rotation

        self.text = text
        self.size = size
        self.align = align
        self._text_cache = []

        self.file = file
        self._bitmap_cache = None

        self.x2 = x2
        self.y2 = y2
        self.x3 = x3
        self.y3 = y3

        self.parent = parent
        self.children = []

        self.src = src
        self.dst = dst

        self.goal_x = None
        self.goal_y = None
        self.velocity = None

    def __repr__(self):
        # box [b1] 24 x 345 @ (34, 38) cyan
        repr = '{} [{}] {} x {} @ ({}, {}) {}\n'.format(
            self.type, self.name, self.width, self.height, self.x, self.y,
            self.color)
        return repr

    def move(self, x, y):
        if self.parent:
            cell.die("cannot move attached object '%s'", self.name)
        else:
            self.x, self.y = x, y
            for child in self.children:
                child.reposition()

    def shift(self, dx, dy):
        self.move(self.x + dx, self.y + dy)

    def resize(self, width, height):
        self.width = width
        self.height = height

    def dist_to_goal(self):
        return math.sqrt((self.goal_x - self.x)**2 + (self.goal_y - self.y)**2)

    def attach(self, parent, dx, dy):
        parent.children.append(self)
        self.parent = parent
        self.x2, self.y2 = dx, dy
        self.reposition()

    def reposition(self):
        if self.parent:
            self.x = self.parent.x + self.x2
            self.y = self.parent.y + self.y2
        for child in self.children:
            child.reposition()

    def vertices(self):
        if self.type != 'polygon':
            cell.die("object type muyst be 'polygon'")
        vertices = []
        theta = cell.deg2rad(self.rotation) - cell.PI / 2
        r = self.width / 2
        for _ in range(self.n):
            vertices.append(
                [self.x + math.cos(theta) * r, self.y + math.sin(theta) * r])
            theta += 2 * cell.PI / self.n
        return vertices

    def rotate_around(self, degree, cx, cy):
        theta = cell.deg2rad(degree)
        (dx, dy) = (self.x - cx, self.y - cy)
        (dx, dy) = (dx * math.cos(theta) + dy * math.sin(theta),
                    dx * math.sin(theta) - dy * math.cos(theta))
        self.move(cx + dx, cy + dy)
